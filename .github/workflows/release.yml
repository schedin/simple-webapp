name: Release Container Images

on:
  release:
    types: [published]

env:
  REGISTRY: ghcr.io
  FRONTEND_IMAGE_NAME: ${{ github.repository }}-frontend
  BACKEND_IMAGE_NAME: ${{ github.repository }}-backend

jobs:
  build-frontend:
    name: Build Web Frontend
    runs-on: self-hosted
    env:
      FRONTEND_IMAGE_NAME: counter-web
      FRONTEND_IMAGE_TAG: ${{ github.event.release.tag_name }}
    defaults:
      run:
        working-directory: ./web

    steps:
      - uses: actions/checkout@v3
          
      - name: Install dependencies
        run: npm ci

      - name: Build frontend
        run: npm run build

      - name: Build Docker image
        run: podman build -t ${{ FRONTEND_IMAGE_NAME }}:${{ FRONTEND_IMAGE_TAG }} .

      - name: Push container  to registry
        run: skopeo copy skopeo copy containers-storage:osix/certificates docker://{REGISTRY}/{{ FRONTEND_IMAGE_NAME }}:${{ FRONTEND_IMAGE_TAG }}

  build-backend:
    name: Build Kotlin Backend
    runs-on: self-hosted
    defaults:
      run:
        working-directory: ./backend
        
    steps:
      - uses: actions/checkout@v3

      - name: Build everything
        run: ./build-and-package.sh ${{ github.event.release.tag_name }}
